---
title: RX.NET
date: 2018-11-7
tags: 
  - dotnet
  - RX
author: iewihc
location: tw  
---

# [C#] Observer Pattern

def : å®šç¾©å°è±¡é–“ä¸€ç¨®ä¸€å°å¤šçš„ä¾è³´é—œä¿‚ï¼Œç•¶ä¸€å€‹å°è±¡çš„ç‹€æ…‹ç™¼ç”Ÿç‹€æ…‹æ”¹è®Šæ™‚ï¼Œæ‰€æœ‰ä¾è³´ä»–çš„éƒ½å¾—çš„åˆ°é€šçŸ¥ä¸¦è¢«è‡ªå‹•æ›´æ–°ã€‚

- Observable (a.) â‡’ å¯è§€å¯Ÿçš„
- Subscribe (v.) â‡’ è¨‚é–±
- Subject (n.) â‡’ ä¸»é¡Œ

> éœ€æ±‚: æœ‰ä¸€å€‹æ°£è±¡ç«™ï¼Œæœ‰ä¸‰å€‹å‚³æ„Ÿå™¨åˆ†åˆ¥ç‚º:æº«åº¦ã€æ¿•åº¦ã€æ°£å£“ï¼Œæœ‰ä¸€å€‹`WeatherData`å°è±¡ï¼Œè¦å¾æ°£è±¡ç«™ç²å¾—é€™ä¸‰å€‹æ•¸æ“šï¼›ä¸¦å±•ç¤ºå¯¦æ™‚çš„æ•¸æ“šã€‚

e.g. 1.è˜‹æœæ—¥å ±ç™¼è¡Œå ±ç´™ï¼›2.ä½ è¨‚é–±å ±ç´™ï¼Œæ¯ä¸€å¤©éƒ½æœƒæ”¶åˆ°ï¼›3.å–æ¶ˆè¨‚é–±å°±æ”¶ä¸åˆ°ï¼›4.å ±ç¤¾é‹ç‡Ÿæ™‚å°±æœƒæœ‰äººä¸€ç›´å»è¨‚é–±/å–æ¶ˆ

**Publishers + Subscribers = Observer Patternåœ¨è§‚å¯Ÿè€…æ¨¡å¼é‡Œ, æˆ‘ä»¬æŠŠæŠ¥ç¤¾å«åšè¢«è§‚å¯Ÿå¯¹è±¡(Subject), æŠŠè®¢é˜…è€…å«åšè§‚å¯Ÿè€…(Observers)**


![https://yqfile.alicdn.com/img_85460a3a2d4caf32dee9fccbe171ad48.png](https://yqfile.alicdn.com/img_85460a3a2d4caf32dee9fccbe171ad48.png)

- è€é¼ å‡ºä¾†ï¼Œäººè·Ÿè²“(æ“´å……é»)éƒ½æœƒè¢«åš‡è·‘

---

# Rx.net vs RxJS ç­†è¨˜

RX (Reactive Extensions) æ¦‚æ‹¬ç‚ºè§£æ±ºè¤‡é›œéåŒæ­¥çš„å•é¡Œã€‚

ç¨‹å¼æœ‰Imperativeï¼ˆå‘½ä»¤å¼ï¼‰å³ç·šå‹ç·¨ç¨‹é¢¨æ ¼å’ŒDeclarativeï¼ˆè²æ˜å¼ï¼‰é¡ä¼¼LINQã€‚

è²æ˜å¼çš„å¥½è™•æ˜¯ä¸ç”¨åœ¨ä¹ç´°ç¯€æˆ–åº•å±¤åŸç†å³å¯å¾—åˆ°æƒ³è¦çš„çµæœ, e.g. SQLã€LINQ

Observer patternå¦‚è¦–çª—è¢«é»æ“Šæ™‚çš„é€šçŸ¥ã€è€é¼ å‡ºç¾äººå’Œè²“éƒ½æ€•çš„æ¡ˆä¾‹ã€ç‡’ç†±æ°´çš„é€šçŸ¥çš„ç¶“å…¸æ¡ˆä¾‹ã€‚

## Observable

å–®å­—è§£é‡‹: å¯è¢«è§€å¯Ÿçš„ï¼›å¯è¢«è¨‚é–±çš„ï¼›æ˜æ˜Ÿï¼›å¯¦æ³ä¸»

æœƒä¸€ç›´æœ‰streamç”¢ç”Ÿçš„ï¼›ä¸€ç›´è¢«pushçš„ï¼›æœƒé »ç¹ç™¼ç”Ÿçš„äº‹ä»¶ï¼›è³‡æ–™æµï¼›æ™‚é–“åºåˆ—ä¸Šçš„ä¸€é€£ä¸²è³‡æ–™äº‹ä»¶

e.g. windowçš„clickäº‹ä»¶ï¼›

- Observable.Return

## Observer

å–®å­—è§£é‡‹: è§€å¯Ÿè€…ğŸ‘€ï¼›è§€çœ¾

## Subscribe(v.)

å–®å­—è§£é‡‹: è¨‚é–±

èˆ‰ä¸€å€‹ç”Ÿæ´»ä¸­çš„ä¾‹å­ï¼Œå¦‚å¸³è™ŸAã€B ; çŸ¥åå¯¦æ³ä¸»:å¼µ ;

```csharp
var streamer = Observable.Create<å¼µYT>(observer)=>{
		observer.OnNext(1);
				
}
```

# Operator

## Select

- map

```jsx
let a = [1,2,3,4,5,6,7,8];
let source = a.map(e => {
    return e + 10;
});
console.log(source); // [11, 12, 13, 14, 15, 16, 17, 18]
```

```csharp
var num = [1,2,3,4]
source = num.Select(num => num + 1); 
// 2,3,4,5 

```

## Where

- filter

```json
[{"age":"18","name":"john"},{"age":"22","name":"lee"}]
```

```jsx
var source = people.filter(function(item, index, array){
  return item.age < 20;      
});
// {"age":"18","name":"john"}
```

```csharp
var source = people.Where(x=>x.age<20);
// {"age":"18","name":"john"}
```

## Do

- Tap

```jsx
title$ = this.httpClient.get('').pipe(
	tap(data=>console.log(data)),
  map(data => data.title),
  tap(data=>console.log(data)
)
```

```csharp
source
    .Do(value => Console.WriteLine($"Current: {value}")
    .Subscribe();
```

side effect çš„æ“ä½œéƒ½ç›¡å¯èƒ½åœ¨ Do è£¡é¢è™•ç†ã€‚

é€™è£¡çš„ç†è§£æœƒæ˜¯ `console.log` è² è²¬debugï¼Œç´€éŒ„é™¤éŒ¯

ç›¡è€Œä¸å»å½±éŸ¿åˆ°åƒè€ƒå‹åˆ¥(Reference Type)çš„æœ€çµ‚æ•¸æ“š

---


---

# éŸ¿æ‡‰å¼é–‹ç™¼

- è§£æ±ºæœå‹™ç«¯å¯¦ç¾çš„ä½µç™¼æ“ä½œã€åœ¨æœå‹™ç«¯é€šéå¹³è¡Œè¨ˆç®—è§£æ±ºè«‹æ±‚ï¼Œäº¦ç‚ºã€Œè§€å¯Ÿè€…æ¨¡å¼ã€ã€‚
- Publisher (è£½ç‰‡å» )
    - ç”Ÿç”¢è€…ç™¼å¸ƒä¸€å€‹å…ƒç´ 
- Subscriber (è§€çœ¾)
    - æ¶ˆè²»è€…å¾Publisherç²å¾—å…ƒç´ 
    - Error , Next , Complete
- Subscription (é›»å½±é™¢)
    - å°Publisherå’ŒSubscriberåšä¸€å€‹è§£è—•
    - cancel , request
- Processor (å€ç¶“ç†â†’ç¶“ç†â†’å“¡å·¥)
    - æ—¢æ˜¯Publisheråˆæ˜¯Subscriberï¼›åŒæ™‚æ‰®æ¼”å…©å€‹è§’è‰²

## Rx Net

- Event-driven systems in the cloud , client , and IoT devices (äº‹ä»¶é©…å‹•)
1. Popular today in client-side code (ä½¿ç”¨å®¢æˆ¶ç«¯ä»£ç¢¼ã€è¨Šæ¯æµ)
2. Created by Cloud Programmability team at Microsoft (é›»è…¦Aè‡³é›»è…¦Bçš„è¨ˆç®—)
3. Useful in any system where things happen (äº‹æƒ…ç™¼ç”Ÿ)

## IObservable<T>

A sequence of things (ä¸€ç³»åˆ—çš„äº‹ä»¶)ã€æ˜¯æŠ½è±¡çš„(äº‹ä»¶çš„æ–¹å¼)ï¼Œå¯ä»¥è¨‚é–±å®ƒï¼›

- ç•¶æ–°çš„æµæœƒé€šçŸ¥ä½ 
- Don't Call Us , We Will Call you.

Same concept as IEnumerable<T> but ... reactive!

```csharp
// IObservable<int> xs = ...? (æ²’æœ‰IMPLå¯¦ç¾)
IObservable<int> xs = Observable.Range(1,10);
//foreach(int x in xs)
//{
//}
//Callback
xs.Subscrib(x=> Console.WriteLine(x));
```

```csharp
static async Task Main(strings[] args)
{
		IObservable<long> xs = Observable
				.Timer(DateTimeOffset.Now.AddSeconds(1.5),TimeSpan.FromSeconds(0.5)) // 0.5ç§’çµ¦ä¸€å€‹äº‹ä»¶
				.Where(x => x% 2 ==0)
				.Take(5)
		xs.Subscrib(x=> Console.WriteLine(x));
		await new TaskCompletionSource<object>().Task;
}
```

```csharp
static async Task Main(strings[] args)
{
		var xs = Keystrokes.Where(char.IsUpper);
		xs.Subscrib(x=> Console.WriteLine(x));
		await new TaskCompletionSource<object>().Task;
}

static IObservable<char> Keystrokes()
{
		return Observable.Create<char>(
		(obs , cancel) => 
		{
			return Task.Run(()=>
			{
					while (!cancel.IsCancellationRequested)
					{
							char c = Console.ReadKey.KeyChar;
							obs.OnNext(c);
					}
			});
		});
}
```

![%E9%9F%BF%E6%87%89%E5%BC%8F%E9%96%8B%E7%99%BC%20151de94922f646c3bf91bc0c8332cfea/Untitled.png](%E9%9F%BF%E6%87%89%E5%BC%8F%E9%96%8B%E7%99%BC%20151de94922f646c3bf91bc0c8332cfea/Untitled.png)

```csharp
static async Task Main(strings[] args)
{
		var xs = Keystrokes.Where(char.IsUpper).TakeUntil(c == 'Q');
		await new TaskCompletionSource<object>().Task;
}
 

private class Obs<T> : IObserver<T>
{
	 public void OnNext(T value)
	 {
			//foreach things.
			Console.WriteLine(value)
	 }
	 public void OnCompleted()
	 {
			Console.WriteLine("Done!");
	 }
	 public void OnError(Exception error)
	 {
			Console.WriteLine("Aaaaaaargh!!" + error);
	 }

}

static IObservable<char> Keystrokes()
{
		return Observable.Create<char>(
		(obs , cancel) => 
		{
			return Task.Run(()=>
			{
					while (!cancel.IsCancellationRequested)
					{
							char c = Console.ReadKey.KeyChar;
							obs.OnNext(c);
					}
			});
		});
}
```

- LINQ operators (Where, Select , etc)
- Scheduling (è¨ˆæ™‚å™¨æ­£å¥½é‹è¡Œæˆ‘èª¿ç”¨çš„loopï¼Œå›èª¿è©²è¨ˆæ™‚å™¨çš„å¯¦éš›é‹ä½œæ–¹å¼)
    1.  æ™‚é–“æ•æ„Ÿçš„æ“ä½œ: åŸºæ–¼è¨ˆæ™‚å™¨çš„æ“ä½œã€åŸºæ–¼æ™‚é–“å°‡äº‹ç‰©åˆ†çµ„ã€æ™‚é–“è·‘æ­¥
    2.  åŸºæ–¼æŸå€‹æ™‚é–“é»ã€å›åˆ°é‡å‰
- Bridging (subjects , Observable.Create)
    - ä»»å‹™(äº‹ä»¶)ã€éåŒæ­¥æµ
    - ç®¡ç†è¨‚é–±ç®¡ç†å–æ¶ˆï¼Œæ‹‹å‡ºç•°å¸¸è€Œä¸æ˜¯è‡ªå‹•è™•ç†å®ƒ (å‘¼å«å®Œæˆ)

 

```csharp
static async Task Main(strings[] args)
{
		var xs = Keystrokes.Where(char.IsUpper).TakeUntil(c == 'Q').Publish().RefCount();
		xs.Subscribe(new Obs<char>());
		IObservable<char> theLastChar = xs.LastAsync();
		await theLastChar;
}
 

private class Obs<T> : IObserver<T>
{
	 public void OnNext(T value)
	 {
			//foreach things.
			Console.WriteLine(value)
	 }
	 public void OnCompleted()
	 {
			Console.WriteLine("Done!");
	 }
	 public void OnError(Exception error)
	 {
			Console.WriteLine("Aaaaaaargh!!" + error);
	 }

}

static IObservable<char> Keystrokes()
{
		return Observable.Create<char>(
		(obs , cancel) => 
		{
			return Task.Run(()=>
			{
					while (!cancel.IsCancellationRequested)
					{
							char c = Console.ReadKey.KeyChar;
							obs.OnNext(c);
					}
			});
		});
}
```

[WHY RX](https://www.notion.so/WHY-RX-90c02293fd33487e81400151705656a0)
